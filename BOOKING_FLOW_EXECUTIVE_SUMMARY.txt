================================================================================
                    ANALYSE DU FLUX DE R√âSERVATION - R√âSUM√â EX√âCUTIF
================================================================================

PROJET: Riderapp (Ride-hailing App - Madagascar)
OBJECTIF: Ajouter support du "num√©ro de vol" pour les courses a√©roport
NIVEAU COMPLEXIT√â: Medium
DATE: 2025-11-05

================================================================================
1. FLUX DE S√âLECTION D'ADRESSE (PICKUP ‚Üí DROP)
================================================================================

TRAJET UTILISATEUR COMPLET:

1. Home Screen (setYourDestination)
   ‚îî‚îÄ> Utilisateur clique "O√π allez-vous?"
   
2. PickupAndDropLocation Bottom Sheet (choosePickupDropLocation)
   Fichier: /lib/bottom_sheet_widget/pickup_and_drop_location_sheet.dart
   ‚îî‚îÄ> Mode 1: Saisie texte avec suggestions auto-compl√®te
   ‚îî‚îÄ> Mode 2: S√©lection par d√©placement des pins sur la carte
   ‚îî‚îÄ> Utilisateur confirme pickup & drop
   
3. Callback onTap(pickup, drop)
   Transmet les Maps au TripProvider:
   {
     "lat": 18.8792,
     "lng": 47.5079,
     "address": "Ivato, Antananarivo, Madagascar"
   }
   
4. TripProvider.pickLocation et dropLocation mis √† jour
   ‚îî‚îÄ> createPath() calcule route, distance, dur√©e
   
5. ChooseVehicleSheet (chooseVehicle)
   ‚îî‚îÄ> Utilisateur s√©lectionne type de v√©hicule
   
6. ConfirmDestination Bottom Sheet (confirmDestination) üîë √âTAPE CRITIQUE
   Fichier: /lib/bottom_sheet_widget/confirm_destination.dart
   ‚îî‚îÄ> Affichage LECTURE SEULE des adresses
   ‚îî‚îÄ> Bouton CONFIRM appelle createRequest()
   
7. TripProvider.createRequest() ‚Üí createBooking()
   Fichier: /lib/provider/trip_provider.dart (ligne 2147+)
   ‚îî‚îÄ> Cr√©ation du Map<String, dynamic> data
   ‚îî‚îÄ> Sauvegarde en Firestore (collection: bookingRequest)
   
8. RequestForRide (requestForRide)
   ‚îî‚îÄ> En attente d'acceptation du chauffeur

================================================================================
2. WIDGETS/BOTTOM SHEETS IMPLIQU√âS
================================================================================

√âCRAN 1: PickupAndDropLocation
   - Fichier: /lib/bottom_sheet_widget/pickup_and_drop_location_sheet.dart
   - Classe: PickupAndDropLocation (StatefulWidget)
   - Fonction: Saisie des deux adresses
   - Donn√©es g√©r√©es: pickupLocation, dropLocation (Maps)
   - Tracking: Abandons, analytics

√âCRAN 2: ChooseVehicleSheet
   - Fichier: /lib/bottom_sheet_widget/choose_vehicle_sheet.dart
   - Fonction: S√©lection du type de v√©hicule

√âCRAN 3: ConfirmDestination üîë
   - Fichier: /lib/bottom_sheet_widget/confirm_destination.dart
   - Classe: ConfirmDestination (StatefulWidget)
   - Fonction: Confirmation finale AVANT cr√©ation booking
   - Contient le bouton qui d√©clenche createRequest()
   - Affichage READ-ONLY des adresses

√âCRAN 4: RequestForRide
   - Fichier: /lib/bottom_sheet_widget/request_for_ride.dart
   - Fonction: √âtat en attente (affichage du trajet + loading)

================================================================================
3. STRUCTURE DES DONN√âES - PICKUP/DROP LOCATIONS
================================================================================

DANS M√âMOIRE (TripProvider):
   Map pickLocation = {
     "lat": double,
     "lng": double,
     "address": string,
     "city": string? (optionnel),
     "controller": TextEditingController
   }

EN FIRESTORE (bookingRequest document):
   "pickLat": 18.8792,
   "pickLng": 47.5079,
   "pickAddress": "Ivato, Antananarivo, Madagascar",
   "city": "Antananarivo",
   
   "dropLat": 18.8798,
   "dropLng": 47.5085,
   "dropAddress": "Analakely, Antananarivo, Madagascar",

CHAMPS ACTUELLEMENT DANS FIRESTORE:
   - Adresses: pickAddress, dropAddress
   - Coordonn√©es: pickLat, pickLng, dropLat, dropLng
   - Distance: distance_in_km_approx
   - Route: currentRouteIndex, coveredPath
   - Autres: vehicle, paymentMethod, status, timestamps, prix, OTP, etc.

*** AUCUN CHAMP "flightNumber" ou "isAirport" EXISTANT ***

================================================================================
4. D√âTECTION D'A√âROPORT - √âTAT ACTUEL
================================================================================

R√âSULTAT: AUCUNE d√©tection d'a√©roport existante

Recherche effectu√©e (grep r√©cursif):
   ‚úó "airport"  -> 0 r√©sultats
   ‚úó "aeroport" -> 0 r√©sultats
   ‚úó "a√©roport" -> 0 r√©sultats

IMPLICATION: La logique de d√©tection d'a√©roport doit √™tre impl√©ment√©e de z√©ro

================================================================================
5. CHAMPS ACTUELS DU BOOKING EN FIRESTORE
================================================================================

Map<String, dynamic> data = {
  // Identifiants
  "id": string,                    // Auto-g√©n√©r√© ou r√©utilis√©
  "requestBy": string,             // ID utilisateur
  "acceptedBy": null (initialement),
  
  // Adresses (sources: pickLocation et dropLocation)
  "pickLat": double,
  "pickLng": double,
  "pickAddress": string,
  "city": string,
  "dropLat": double,
  "dropLng": double,
  "dropAddress": string,
  
  // V√©hicule & Tarification
  "vehicle": string,               // ID du type de v√©hicule
  "paymentMethod": string,
  "vehicle_price_per_km": double,
  "vehicle_base_price": double,
  "vehicle_price_per_min": double,
  "total_ride_price": string,
  "ride_price_to_pay": string,
  
  // Route & Distance
  "distance_in_km_approx": string,
  "currentRouteIndex": int,
  "coveredPath": List,
  
  // Statut & Timing
  "ride_status": string,           // "Running"
  "status": int,                   // 0=demande, 1=accept√©e, etc
  "requestTime": Timestamp,
  "acceptedTime": null,
  "startedTime": null,
  "scheduleTime": Timestamp,
  "isSchedule": bool,
  
  // S√©curit√©
  "bookingOTP": string,            // Code OTP
  
  // Autres
  "rejectedBY": List,
  "chats": List,
  "ride_cancelled_by": string,
};

================================================================================
6. POINTS D'INT√âGRATION RECOMMAND√âS POUR LE NUM√âRO DE VOL
================================================================================

APPROCHE PROPOS√âE: 3 points d'int√©gration

POINT 1: PickupAndDropLocation (d√©tection lors saisie)
   Localisation: /lib/bottom_sheet_widget/pickup_and_drop_location_sheet.dart
   
   Actions:
   - Ajouter m√©thode: bool isAirportAddress(String address)
   - Lors de la saisie/confirmation de l'adresse, v√©rifier si contient:
     * "airport", "a√©roport", "aeroport"
     * Noms d'a√©roports connus (Ivato, etc.)
   - Si a√©roport d√©tect√©: afficher champ TextInput pour "Flight Number"
   - Stocker dans pickLocation/dropLocation: {"flightNumber": "...", "isAirport": true}

POINT 2: ConfirmDestination (validation avant confirmation)
   Localisation: /lib/bottom_sheet_widget/confirm_destination.dart
   
   Actions:
   - Avant d'appeler createRequest(), v√©rifier pickLocation et dropLocation
   - Si isAirport==true et flightNumber vide: afficher alerte + bloquer
   - Afficher le num√©ro de vol √† l'utilisateur pour confirmation

POINT 3: TripProvider.createBooking() (sauvegarde Firestore)
   Localisation: /lib/provider/trip_provider.dart (ligne 2163+)
   
   Actions:
   - Extraire flightNumber de pickLocation et dropLocation
   - Ajouter au Map data:
     * "pickFlightNumber": pickupLocation?['flightNumber'] ?? ""
     * "dropFlightNumber": dropLocation?['flightNumber'] ?? ""
     * "pickIsAirport": pickupLocation?['isAirport'] ?? false
     * "dropIsAirport": dropLocation?['isAirport'] ?? false

================================================================================
7. ARCHITECTURE TECHNIQUE - NOTES IMPORTANTES
================================================================================

POINTS CL√âS:

1. Pas de mod√®les TypeSafe
   ‚úó Pas de classe Location ou Address
   ‚úó Pas de classe Booking (utilise Map<String, dynamic>)
   ‚Üí Tout est en Maps dynamiques

2. Adresses stock√©es comme texte brut
   ‚Üí pickAddress et dropAddress sont des strings
   ‚Üí Pas de geocoding inverse

3. Pas de validation d'adresse
   ‚Üí Les coordonn√©es et l'adresse peuvent ne pas matcher parfaitement

4. Syst√®me de tracking d'abandon
   ‚Üí PickupAndDropLocation log les abandons (timeout 60s)
   ‚Üí Analytics int√©gr√©: logDestinationSearched(), logAddressSelectionAbandoned()

5. Pattern Provider avec ChangeNotifier
   ‚Üí TripProvider g√®re tout l'√©tat de la r√©servation
   ‚Üí pickLocation et dropLocation sont des propri√©t√©s simples

6. Transitions d'√©cran via CustomTripType enum
   ‚Üí 10 √©tats distincts pour le flux de r√©servation
   ‚Üí setScreen() change l'√©tat et met √† jour l'UI

7. Firestore collections
   ‚Üí bookingRequest: nouveau booking
   ‚Üí bookingHistory: booking compl√©t√©/annul√©

================================================================================
8. R√âSUM√â FICHIERS CL√âS √Ä EXAMINER
================================================================================

FLUX D'ADRESSE:
1. /lib/pages/view_module/home_screen.dart (ligne 1140-1184)
   - Int√©gration du widget PickupAndDropLocation

2. /lib/bottom_sheet_widget/pickup_and_drop_location_sheet.dart
   - Saisie pickup & drop

3. /lib/bottom_sheet_widget/confirm_destination.dart
   - Confirmation avant cr√©ation du booking

4. /lib/provider/trip_provider.dart (ligne 2147+)
   - M√©thode createBooking() qui sauvegarde en Firestore

√âNUMS & CONSTANTS:
5. /lib/contants/global_data.dart
   - Enum CustomTripType avec 10 √©tats

MOD√àLES:
6. /lib/modal/vehicle_modal.dart
   - Classe VehicleModal pour les types de v√©hicules

================================================================================
9. PROCHAINES √âTAPES RECOMMAND√âES
================================================================================

PHASE 1: IMPL√âMENTATION DE LA D√âTECTION
   [ ] Cr√©er service d'a√©roports (airports_service.dart)
   [ ] Lister a√©roports malgaches connus
   [ ] Ajouter m√©thode isAirport(String address) dans TripProvider

PHASE 2: UI - SAISIE DU NUM√âRO DE VOL
   [ ] Modifier PickupAndDropLocation pour afficher champ conditionnel
   [ ] Ajouter validation du format du num√©ro de vol
   [ ] Afficher indication visuelle (ic√¥ne avion) si a√©roport

PHASE 3: CONFIRMATION & STOCKAGE
   [ ] Modifier ConfirmDestination pour afficher et valider flight number
   [ ] Modifier createBooking() pour ajouter champs Firestore
   [ ] Ajouter index Firestore pour filtrer par a√©roport

PHASE 4: CHAUFFEUR & AFFICHAGE
   [ ] Afficher num√©ro de vol dans RequestForRide
   [ ] Afficher num√©ro de vol dans DriverOnWay
   [ ] Afficher num√©ro de vol dans l'historique de course

================================================================================
10. D√âPENDANCES & SERVICES UTILIS√âS
================================================================================

SERVICES EXISTANTS:
   - FirestoreServices: gestion Firestore
   - AnalyticsService: tracking des √©v√©nements
   - LocationService: g√©olocalisation
   - GoogleMapProvider: gestion de la carte

LIBS UTILIS√âES:
   - google_maps_flutter: pour la s√©lection sur carte
   - cloud_firestore: pour la sauvegarde
   - provider: pour la gestion d'√©tat
   - geolocator: pour distance entre points

================================================================================

DOCUMENTS G√âN√âR√âS:
   - BOOKING_FLOW_ANALYSIS.md (10 KB) - Analyse d√©taill√©e
   - BOOKING_FLOW_DIAGRAM.txt (9 KB) - Diagramme visuel
   - EXECUTIVE_SUMMARY.txt (ce fichier)

