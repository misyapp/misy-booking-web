<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Widget Misy Booking</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyALcvZZmiEonxqzce2fYyZvqc9wiByYO3g&libraries=places&language=fr&region=MG"></script>
</head>
<body style="margin: 0; padding: 40px; background: #f5f5f5; min-height: 100vh; display: flex; justify-content: center; align-items: center;">

<!-- ============================================== -->
<!-- WIDGET MISY BOOKING - VERSION FINALE          -->
<!-- Copiez le code entre les balises DÉBUT/FIN    -->
<!-- ============================================== -->

<!-- DÉBUT DU WIDGET -->
<style>
.misy-widget {
  font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
  max-width: 400px;
  padding: 28px;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
}
.misy-widget * { box-sizing: border-box; }

/* Logo */
.misy-logo {
  height: 32px;
  margin-bottom: 20px;
}

/* Titre */
.misy-widget-title {
  font-size: 24px;
  font-weight: 700;
  line-height: 1.3;
  margin: 0 0 24px 0;
  color: #1D1D1F;
}

/* Bouton planification */
.misy-schedule-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: #f5f5f5;
  border: none;
  border-radius: 20px;
  padding: 10px 16px;
  font-size: 14px;
  font-weight: 500;
  color: #1D1D1F;
  cursor: pointer;
  margin-bottom: 20px;
  font-family: inherit;
  transition: background 0.2s;
}
.misy-schedule-btn:hover { background: #ebebeb; }
.misy-schedule-btn svg { width: 18px; height: 18px; }

/* Container inputs */
.misy-inputs-container {
  position: relative;
  margin-bottom: 20px;
}
.misy-inputs-line {
  position: absolute;
  left: 17px;
  top: 24px;
  bottom: 24px;
  width: 2px;
  background: #1D1D1F;
}

/* Groupe input */
.misy-input-group {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 0;
  border-bottom: 1px solid #e8e8e8;
}
.misy-input-group:last-child { border-bottom: none; }

/* Icônes */
.misy-input-icon {
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.misy-input-icon-circle {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: #fff;
  border: 2px solid #1D1D1F;
}
.misy-input-icon-square {
  width: 12px;
  height: 12px;
  background: #fff;
  border: 2px solid #1D1D1F;
  border-radius: 2px;
}

/* Input */
.misy-input {
  flex: 1;
  border: none;
  outline: none;
  font-size: 15px;
  font-family: inherit;
  color: #1D1D1F;
  background: transparent;
  min-width: 0;
  width: 100%;
}
.misy-input::placeholder {
  color: #86868B;
}

/* Bouton localisation */
.misy-location-btn {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: transparent;
  border: none;
  cursor: pointer;
  color: #86868B;
  border-radius: 8px;
  transition: all 0.2s;
}
.misy-location-btn:hover {
  background: #f5f5f5;
  color: #FF5357;
}

/* Bouton submit */
.misy-submit-btn {
  width: 100%;
  background: #FF5357;
  color: #fff;
  border: none;
  border-radius: 12px;
  padding: 16px 24px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  transition: background 0.2s;
  box-shadow: 0 4px 12px rgba(255, 83, 87, 0.3);
}
.misy-submit-btn:hover { background: #E84347; }

/* Lien connexion */
.misy-login-link {
  display: block;
  text-align: center;
  margin-top: 16px;
  color: #86868B;
  font-size: 13px;
  text-decoration: none;
}
.misy-login-link:hover {
  color: #FF5357;
  text-decoration: underline;
}

/* Style autocomplete Google */
.pac-container {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
  border-radius: 12px;
  margin-top: 8px;
  border: none;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  z-index: 10000 !important;
}
.pac-item {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
  padding: 12px 14px;
  cursor: pointer;
  border-top: 1px solid #f0f0f0;
  line-height: 1.4;
}
.pac-item:first-child { border-top: none; }
.pac-item:hover { background: #f8f8f8; }
.pac-item-query {
  font-size: 14px;
  color: #1D1D1F;
  font-family: inherit !important;
}
.pac-icon {
  display: none;
}
.pac-item-query, .pac-matched {
  font-weight: 500;
}
.pac-secondary-query {
  font-family: inherit !important;
  color: #86868B;
}

/* Animation spinner */
@keyframes misy-spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
.misy-spin { animation: misy-spin 1s linear infinite; }
</style>

<div class="misy-widget">
  <!-- Logo Misy -->
  <img src="https://book.misy.app/assets/assets/icons/misy_logo_rose.png" alt="Misy" class="misy-logo">

  <h2 class="misy-widget-title">Où voulez-vous aller ?</h2>

  <button class="misy-schedule-btn" onclick="toggleMisySchedule()">
    <svg viewBox="0 0 24 24" fill="currentColor">
      <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"/>
    </svg>
    <span id="misyScheduleText">Maintenant</span>
    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
      <path d="M7 10l5 5 5-5z"/>
    </svg>
  </button>

  <form id="misyBookingForm" onsubmit="submitMisyBooking(event)">
    <div class="misy-inputs-container">
      <div class="misy-inputs-line"></div>

      <div class="misy-input-group">
        <div class="misy-input-icon">
          <div class="misy-input-icon-circle"></div>
        </div>
        <input type="text" class="misy-input" id="misyPickup" placeholder="Lieu de prise en charge" required autocomplete="off">
        <button type="button" class="misy-location-btn" onclick="getMisyLocation()" title="Utiliser ma position">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0013 3.06V1h-2v2.06A8.994 8.994 0 003.06 11H1v2h2.06A8.994 8.994 0 0011 20.94V23h2v-2.06A8.994 8.994 0 0020.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
          </svg>
        </button>
      </div>

      <div class="misy-input-group">
        <div class="misy-input-icon">
          <div class="misy-input-icon-square"></div>
        </div>
        <input type="text" class="misy-input" id="misyDestination" placeholder="Destination" required autocomplete="off">
      </div>
    </div>

    <button type="submit" class="misy-submit-btn">Commander</button>
  </form>

  <a class="misy-login-link" href="https://book.misy.app" target="_blank">Accéder à book.misy.app</a>
</div>

<script>
// État du widget
var misyPickupData = null;
var misyDestinationData = null;

// Initialisation autocomplete Google Places
function initMisyAutocomplete() {
  var options = {
    componentRestrictions: { country: 'mg' },
    fields: ['formatted_address', 'geometry', 'name', 'place_id']
  };

  // Autocomplete pickup
  var pickupInput = document.getElementById('misyPickup');
  var pickupAutocomplete = new google.maps.places.Autocomplete(pickupInput, options);

  pickupAutocomplete.addListener('place_changed', function() {
    var place = pickupAutocomplete.getPlace();
    if (place.geometry) {
      misyPickupData = {
        address: place.formatted_address || place.name,
        lat: place.geometry.location.lat(),
        lng: place.geometry.location.lng(),
        placeId: place.place_id
      };
      // Focus sur destination
      document.getElementById('misyDestination').focus();
    }
  });

  // Autocomplete destination
  var destInput = document.getElementById('misyDestination');
  var destAutocomplete = new google.maps.places.Autocomplete(destInput, options);

  destAutocomplete.addListener('place_changed', function() {
    var place = destAutocomplete.getPlace();
    if (place.geometry) {
      misyDestinationData = {
        address: place.formatted_address || place.name,
        lat: place.geometry.location.lat(),
        lng: place.geometry.location.lng(),
        placeId: place.place_id
      };
    }
  });
}

// Soumission du formulaire
function submitMisyBooking(event) {
  event.preventDefault();

  var pickup = document.getElementById('misyPickup').value.trim();
  var destination = document.getElementById('misyDestination').value.trim();

  if (!pickup || !destination) {
    alert('Veuillez renseigner le lieu de prise en charge et la destination.');
    return;
  }

  // Construire l'URL avec les paramètres
  var params = new URLSearchParams();

  if (misyPickupData && misyPickupData.lat) {
    params.set('pickup', misyPickupData.address);
    params.set('pickupLat', misyPickupData.lat);
    params.set('pickupLng', misyPickupData.lng);
  } else {
    params.set('pickup', pickup);
  }

  if (misyDestinationData && misyDestinationData.lat) {
    params.set('destination', misyDestinationData.address);
    params.set('destLat', misyDestinationData.lat);
    params.set('destLng', misyDestinationData.lng);
  } else {
    params.set('destination', destination);
  }

  // Rediriger vers book.misy.app
  var url = 'https://book.misy.app/#/home?' + params.toString();
  window.open(url, '_blank');
}

// Géolocalisation
function getMisyLocation() {
  if (!navigator.geolocation) {
    alert('La géolocalisation n\'est pas supportée par votre navigateur.');
    return;
  }

  var btn = document.querySelector('.misy-location-btn');
  var originalIcon = btn.innerHTML;

  // Afficher spinner
  btn.innerHTML = '<svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor" class="misy-spin"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>';

  navigator.geolocation.getCurrentPosition(
    function(position) {
      var lat = position.coords.latitude;
      var lng = position.coords.longitude;

      var geocoder = new google.maps.Geocoder();
      geocoder.geocode({ location: { lat: lat, lng: lng } }, function(results, status) {
        btn.innerHTML = originalIcon;

        if (status === 'OK' && results[0]) {
          document.getElementById('misyPickup').value = results[0].formatted_address;
          misyPickupData = {
            address: results[0].formatted_address,
            lat: lat,
            lng: lng,
            placeId: results[0].place_id
          };
          // Focus sur destination
          document.getElementById('misyDestination').focus();
        } else {
          document.getElementById('misyPickup').value = lat.toFixed(6) + ', ' + lng.toFixed(6);
          misyPickupData = { address: lat + ', ' + lng, lat: lat, lng: lng, placeId: null };
        }
      });
    },
    function(error) {
      btn.innerHTML = originalIcon;
      alert('Impossible d\'obtenir votre position. Vérifiez les permissions.');
    },
    { enableHighAccuracy: true, timeout: 10000 }
  );
}

// Toggle planification (à implémenter plus tard)
function toggleMisySchedule() {
  alert('Réservation planifiée bientôt disponible !');
}

// Initialiser au chargement
initMisyAutocomplete();
</script>
<!-- FIN DU WIDGET -->

</body>
</html>
