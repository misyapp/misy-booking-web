<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Widget Misy Booking - Test</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyALcvZZmiEonxqzce2fYyZvqc9wiByYO3g&libraries=places"></script>
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
      padding: 40px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: 'Poppins', sans-serif;
    }
  </style>
</head>
<body>

<!-- ============================================== -->
<!-- WIDGET MISY BOOKING                            -->
<!-- ============================================== -->

<style>
.misy-widget {
  font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
  max-width: 400px;
  padding: 32px;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
}
.misy-widget * { box-sizing: border-box; }
.misy-widget-title {
  font-size: 36px;
  font-weight: 700;
  line-height: 1.2;
  margin: 0 0 24px 0;
  color: #000;
}
.misy-widget-title span { color: #E91E63; }
.misy-schedule-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: #f3f3f3;
  border: none;
  border-radius: 24px;
  padding: 10px 16px;
  font-size: 14px;
  font-weight: 500;
  color: #000;
  cursor: pointer;
  margin-bottom: 20px;
  font-family: inherit;
}
.misy-schedule-btn:hover { background: #e8e8e8; }
.misy-schedule-btn svg { width: 18px; height: 18px; }
.misy-inputs-container { position: relative; margin-bottom: 20px; }
.misy-inputs-line {
  position: absolute;
  left: 19px;
  top: 20px;
  bottom: 20px;
  width: 2px;
  background: #000;
}
.misy-input-group {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 0;
  border-bottom: 1px solid #e8e8e8;
}
.misy-input-group:last-child { border-bottom: none; }
.misy-input-icon {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.misy-input-icon-circle {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: #000;
}
.misy-input-icon-square {
  width: 10px;
  height: 10px;
  background: #000;
}
.misy-input {
  flex: 1;
  border: none;
  outline: none;
  font-size: 16px;
  font-family: inherit;
  color: #000;
  background: transparent;
  min-width: 0;
  width: 100%;
}
.misy-input::placeholder {
  color: #757575;
  opacity: 1;
}
.misy-location-btn {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: transparent;
  border: none;
  cursor: pointer;
  color: #000;
}
.misy-location-btn:hover { background: #f3f3f3; border-radius: 8px; }
.misy-submit-btn {
  width: 100%;
  background: #E91E63;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 14px 24px;
  font-size: 16px;
  font-weight: 500;
  cursor: pointer;
  font-family: inherit;
  transition: background 0.2s;
}
.misy-submit-btn:hover { background: #C2185B; }
.misy-login-link {
  display: block;
  text-align: center;
  margin-top: 16px;
  color: #000;
  font-size: 14px;
  text-decoration: underline;
  cursor: pointer;
}
.misy-login-link:hover { color: #E91E63; }

.pac-container {
  font-family: 'Poppins', sans-serif;
  border-radius: 8px;
  margin-top: 4px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.pac-item { padding: 10px 12px; cursor: pointer; }
.pac-item:hover { background: #f5f5f5; }
.pac-item-query { font-size: 14px; color: #000; }

@keyframes misy-spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
.misy-spin { animation: misy-spin 1s linear infinite; }
</style>

<div class="misy-widget">
  <h2 class="misy-widget-title">Allez où vous voulez avec <span>Misy</span></h2>

  <button class="misy-schedule-btn" onclick="toggleMisySchedule()">
    <svg viewBox="0 0 24 24" fill="currentColor">
      <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"/>
    </svg>
    <span>Prendre en charge maintenant</span>
    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
      <path d="M7 10l5 5 5-5z"/>
    </svg>
  </button>

  <form id="misyBookingForm" onsubmit="submitMisyBooking(event)">
    <div class="misy-inputs-container">
      <div class="misy-inputs-line"></div>

      <div class="misy-input-group">
        <div class="misy-input-icon">
          <div class="misy-input-icon-circle"></div>
        </div>
        <input type="text" class="misy-input" id="misyPickup" placeholder="Lieu de prise en charge" required autocomplete="off">
        <button type="button" class="misy-location-btn" onclick="getMisyLocation()" title="Utiliser ma position">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0013 3.06V1h-2v2.06A8.994 8.994 0 003.06 11H1v2h2.06A8.994 8.994 0 0011 20.94V23h2v-2.06A8.994 8.994 0 0020.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
          </svg>
        </button>
      </div>

      <div class="misy-input-group">
        <div class="misy-input-icon">
          <div class="misy-input-icon-square"></div>
        </div>
        <input type="text" class="misy-input" id="misyDestination" placeholder="Destination" required autocomplete="off">
      </div>
    </div>

    <button type="submit" class="misy-submit-btn">Voir les prix</button>
  </form>

  <a class="misy-login-link" href="https://book.misy.app/#/login" target="_blank">Connectez-vous pour consulter votre activité récente</a>
</div>

<script>
var misyPickupData = null;
var misyDestinationData = null;

function initMisyAutocomplete() {
  var options = {
    componentRestrictions: { country: 'mg' },
    fields: ['formatted_address', 'geometry', 'name', 'place_id']
  };

  var pickupInput = document.getElementById('misyPickup');
  var pickupAutocomplete = new google.maps.places.Autocomplete(pickupInput, options);

  pickupAutocomplete.addListener('place_changed', function() {
    var place = pickupAutocomplete.getPlace();
    if (place.geometry) {
      misyPickupData = {
        address: place.formatted_address || place.name,
        lat: place.geometry.location.lat(),
        lng: place.geometry.location.lng(),
        placeId: place.place_id
      };
    }
  });

  var destInput = document.getElementById('misyDestination');
  var destAutocomplete = new google.maps.places.Autocomplete(destInput, options);

  destAutocomplete.addListener('place_changed', function() {
    var place = destAutocomplete.getPlace();
    if (place.geometry) {
      misyDestinationData = {
        address: place.formatted_address || place.name,
        lat: place.geometry.location.lat(),
        lng: place.geometry.location.lng(),
        placeId: place.place_id
      };
    }
  });
}

function submitMisyBooking(event) {
  event.preventDefault();

  if (misyPickupData && misyDestinationData) {
    var params = new URLSearchParams({
      pickup: misyPickupData.address,
      pickupLat: misyPickupData.lat,
      pickupLng: misyPickupData.lng,
      destination: misyDestinationData.address,
      destLat: misyDestinationData.lat,
      destLng: misyDestinationData.lng
    });

    var url = 'https://book.misy.app/#/search?' + params.toString();
    console.log('URL:', url);
    window.open(url, '_blank');
  } else {
    var pickup = document.getElementById('misyPickup').value.trim();
    var destination = document.getElementById('misyDestination').value.trim();

    if (pickup && destination) {
      var url = 'https://book.misy.app/#/search?pickup=' + encodeURIComponent(pickup) + '&destination=' + encodeURIComponent(destination);
      window.open(url, '_blank');
    } else {
      alert('Veuillez sélectionner un lieu de prise en charge et une destination');
    }
  }
}

function getMisyLocation() {
  if (navigator.geolocation) {
    var btn = document.querySelector('.misy-location-btn');
    btn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="misy-spin"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>';

    navigator.geolocation.getCurrentPosition(
      function(position) {
        var lat = position.coords.latitude;
        var lng = position.coords.longitude;

        var geocoder = new google.maps.Geocoder();
        geocoder.geocode({ location: { lat: lat, lng: lng } }, function(results, status) {
          btn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0013 3.06V1h-2v2.06A8.994 8.994 0 003.06 11H1v2h2.06A8.994 8.994 0 0011 20.94V23h2v-2.06A8.994 8.994 0 0020.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>';

          if (status === 'OK' && results[0]) {
            document.getElementById('misyPickup').value = results[0].formatted_address;
            misyPickupData = {
              address: results[0].formatted_address,
              lat: lat,
              lng: lng,
              placeId: results[0].place_id
            };
          } else {
            document.getElementById('misyPickup').value = lat + ', ' + lng;
            misyPickupData = { address: lat + ', ' + lng, lat: lat, lng: lng, placeId: null };
          }
        });
      },
      function(error) {
        btn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0013 3.06V1h-2v2.06A8.994 8.994 0 003.06 11H1v2h2.06A8.994 8.994 0 0011 20.94V23h2v-2.06A8.994 8.994 0 0020.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>';
        alert('Impossible d\'obtenir votre position.');
      },
      { enableHighAccuracy: true, timeout: 10000 }
    );
  }
}

function toggleMisySchedule() {
  alert('Réservation planifiée bientôt disponible !');
}

initMisyAutocomplete();
</script>

</body>
</html>
