# Algorithmes de Calcul - Tarifs Misy 2.0

## üéØ Vue d'ensemble

Ce document d√©taille les algorithmes de calcul du nouveau syst√®me de tarification, avec exemples concrets et cas d'usage.

## üìê Formule Principale

### Calcul de Base selon Distance

```dart
double calculateBasePrice(String category, double distance, PricingConfigV2 config) {
  final floorPrice = config.floorPrices[category]!;\n  final pricePerKm = config.pricePerKm[category]!;\n  \n  // Cas 1: Distance < seuil prix plancher (3 km)\n  if (distance < config.floorPriceThreshold) {\n    return floorPrice;\n  }\n  \n  // Cas 2: Distance normale (3-15 km)\n  if (distance < config.longTripThreshold) {\n    return pricePerKm * distance;\n  }\n  \n  // Cas 3: Course longue (> 15 km)\n  final normalDistance = config.longTripThreshold;\n  final extraDistance = distance - normalDistance;\n  final extraPrice = extraDistance * pricePerKm * config.longTripMultiplier;\n  \n  return (pricePerKm * normalDistance) + extraPrice;\n}\n```\n\n### Exemples Concrets\n\n**Taxi-moto, 2 km** (Prix plancher)\n```\nDistance: 2 km < 3 km (seuil)\n‚Üí Prix = 6000 MGA (prix plancher)\n```\n\n**Classic, 8 km** (Distance normale)\n```\nDistance: 8 km (entre 3 et 15 km)\n‚Üí Prix = 2750 √ó 8 = 22000 MGA\n```\n\n**Confort, 20 km** (Course longue)\n```\nDistance: 20 km > 15 km (seuil course longue)\n‚Üí Prix normal: 3850 √ó 15 = 57750 MGA\n‚Üí Distance extra: 20 - 15 = 5 km\n‚Üí Prix extra: 5 √ó 3850 √ó 1.2 = 23100 MGA\n‚Üí Prix total: 57750 + 23100 = 80850 MGA\n```\n\n## ‚è∞ Majoration Embouteillages\n\n### Algorithme de D√©tection\n\n```dart\nbool isTrafficHour(DateTime requestTime, List<TrafficPeriod> periods) {\n  for (final period in periods) {\n    if (period.isTrafficTime(requestTime)) {\n      return true;\n    }\n  }\n  return false;\n}\n\ndouble applyTrafficSurcharge(double basePrice, DateTime requestTime, PricingConfigV2 config) {\n  if (isTrafficHour(requestTime, config.trafficPeriods)) {\n    return basePrice * (config.trafficMultiplier - 1); // Retourne la majoration seule\n  }\n  return 0.0;\n}\n```\n\n### Configuration par D√©faut\n\n**P√©riodes d'embouteillages** :\n- **Matin** : 7h00 √† 9h59 (lundi √† vendredi)\n- **Soir** : 16h00 √† 18h59 (lundi √† vendredi)\n- **Multiplicateur** : √ó1.4\n\n### Exemples\n\n**Classic, 10 km, Mardi 8h30** (Embouteillages)\n```\nPrix de base: 2750 √ó 10 = 27500 MGA\nHeure: 8h30 ‚Üí dans p√©riode 7h-9h59 ‚úì\nMajoration: 27500 √ó (1.4 - 1) = 27500 √ó 0.4 = 11000 MGA\nPrix avec embouteillages: 27500 + 11000 = 38500 MGA\n```\n\n**Classic, 10 km, Mardi 14h00** (Pas d'embouteillages)\n```\nPrix de base: 27500 MGA\nHeure: 14h00 ‚Üí hors p√©riodes d'embouteillages\nMajoration: 0 MGA\nPrix final: 27500 MGA\n```\n\n## üìÖ Surco√ªt R√©servation\n\n### Algorithme\n\n```dart\ndouble applyReservationSurcharge(double currentPrice, String category, bool isScheduled, PricingConfigV2 config) {\n  if (!isScheduled) {\n    return 0.0; // Course imm√©diate\n  }\n  \n  return config.reservationSurcharge[category] ?? 0.0;\n}\n```\n\n### Tarifs par Cat√©gorie\n\n| Cat√©gorie | Surco√ªt R√©servation |\n|-----------|--------------------|\n| Taxi-moto | 3600 MGA |\n| Classic | 5000 MGA |\n| Confort | 7000 MGA |\n| 4x4 | 8200 MGA |\n| Van | 9100 MGA |\n\n### Exemple\n\n**4x4, 12 km, programm√© √† l'avance**\n```\nPrix de base: 4500 √ó 12 = 54000 MGA\nR√©servation: Oui ‚Üí +8200 MGA\nTotal: 54000 + 8200 = 62200 MGA\n```\n\n## üé´ Application Codes Promo\n\n### Algorithme\n\n```dart\ndouble applyPromoCode(double currentPrice, PromoCode? promoCode, String vehicleCategory) {\n  if (promoCode == null || !promoCode.isValid(currentPrice, vehicleCategory)) {\n    return 0.0;\n  }\n  \n  final discount = promoCode.calculateDiscount(currentPrice, vehicleCategory);\n  \n  // La r√©duction ne peut pas √™tre sup√©rieure au prix\n  return math.min(discount, currentPrice);\n}\n```\n\n### Types de Codes Promo\n\n**Pourcentage**\n```dart\n// Code \"WELCOME10\" : 10% de r√©duction\nfinal discount = price * 0.10;\n```\n\n**Montant Fixe**\n```dart\n// Code \"SAVE5000\" : 5000 MGA de r√©duction\nfinal discount = 5000.0;\n```\n\n### Exemple\n\n**Classic, 15 km, code \"WELCOME10\" (10%)**\n```\nPrix avant promo: 2750 √ó 15 = 41250 MGA\nR√©duction: 41250 √ó 0.10 = 4125 MGA\nPrix apr√®s promo: 41250 - 4125 = 37125 MGA\n```\n\n## üîÑ Syst√®me d'Arrondis\n\n### Algorithme\n\n```dart\ndouble roundPrice(double price, PricingConfigV2 config) {\n  if (!config.enableRounding) {\n    return price;\n  }\n  \n  final step = config.roundingStep; // 500 MGA\n  return (price / step).round() * step;\n}\n```\n\n### R√®gles d'Arrondi\n\n**Arrondi au multiple de 500 MGA le plus proche**\n\n| Prix Avant | Prix Apr√®s | R√®gle |\n|------------|------------|---------|\n| 37125 MGA | 37000 MGA | 37125 √∑ 500 = 74.25 ‚Üí 74 √ó 500 |\n| 37375 MGA | 37500 MGA | 37375 √∑ 500 = 74.75 ‚Üí 75 √ó 500 |\n| 37250 MGA | 37500 MGA | 37250 √∑ 500 = 74.5 ‚Üí 75 √ó 500 |\n\n### Exemples\n\n```dart\nroundPrice(37125, config) ‚Üí 37000 MGA\nroundPrice(37375, config) ‚Üí 37500 MGA\nroundPrice(42780, config) ‚Üí 43000 MGA\nroundPrice(18000, config) ‚Üí 18000 MGA (d√©j√† rond)\n```\n\n## üßÆ Algorithme Complet\n\n### Fonction Principale\n\n```dart\nclass PricingServiceV2 {\n  Future<PriceCalculation> calculatePrice({\n    required String vehicleCategory,\n    required double distance,\n    required DateTime requestTime,\n    required bool isScheduled,\n    PromoCode? promoCode,\n  }) async {\n    final config = await PricingConfigService.getConfig();\n    \n    // 1. Calcul prix de base\n    final basePrice = _calculateBasePrice(vehicleCategory, distance, config);\n    \n    // 2. Majoration embouteillages\n    final trafficSurcharge = _applyTrafficSurcharge(basePrice, requestTime, config);\n    \n    // 3. Surco√ªt r√©servation\n    final reservationSurcharge = _applyReservationSurcharge(\n      basePrice + trafficSurcharge, \n      vehicleCategory, \n      isScheduled, \n      config\n    );\n    \n    // 4. Prix avant promo\n    final priceBeforePromo = basePrice + trafficSurcharge + reservationSurcharge;\n    \n    // 5. Application code promo\n    final promoDiscount = _applyPromoCode(priceBeforePromo, promoCode, vehicleCategory);\n    \n    // 6. Prix avant arrondi\n    final priceBeforeRounding = priceBeforePromo - promoDiscount;\n    \n    // 7. Arrondi final\n    final finalPrice = _roundPrice(priceBeforeRounding, config);\n    \n    return PriceCalculation.v2(\n      vehicleCategory: vehicleCategory,\n      distance: distance,\n      isScheduled: isScheduled,\n      basePrice: basePrice,\n      trafficSurcharge: trafficSurcharge,\n      reservationSurcharge: reservationSurcharge,\n      promoDiscount: promoDiscount,\n      finalPrice: finalPrice,\n      additionalBreakdown: {\n        'priceBeforeRounding': priceBeforeRounding,\n        'roundingDifference': finalPrice - priceBeforeRounding,\n      },\n    );\n  }\n}\n```\n\n## üìä Cas d'Usage Complets\n\n### Cas 1 : Simple (Sans Majorations)\n\n**Sc√©nario** : Classic, 5 km, Samedi 14h00, Imm√©diat, Pas de promo\n\n```\n1. Prix de base: 2750 √ó 5 = 13750 MGA\n2. Embouteillages: 0 MGA (samedi, pas dans les cr√©neaux)\n3. R√©servation: 0 MGA (imm√©diat)\n4. Code promo: 0 MGA (aucun)\n5. Avant arrondi: 13750 MGA\n6. Arrondi: 13750 √∑ 500 = 27.5 ‚Üí 28 √ó 500 = 14000 MGA\n\n‚Üí Prix final: 14000 MGA\n```\n\n### Cas 2 : Complexe (Toutes Majorations)\n\n**Sc√©nario** : Confort, 18 km, Lundi 17h30, Programm√©, Code \"SAVE3000\"\n\n```\n1. Prix de base (course longue):\n   - Normal: 3850 √ó 15 = 57750 MGA\n   - Extra: (18-15) √ó 3850 √ó 1.2 = 13860 MGA\n   - Total: 57750 + 13860 = 71610 MGA\n\n2. Embouteillages:\n   - 17h30 ‚Üí dans cr√©neau 16h-18h59 ‚úì\n   - Majoration: 71610 √ó 0.4 = 28644 MGA\n\n3. R√©servation:\n   - Programm√© ‚Üí +7000 MGA\n\n4. Avant promo: 71610 + 28644 + 7000 = 107254 MGA\n\n5. Code promo \"SAVE3000\":\n   - R√©duction: 3000 MGA\n\n6. Avant arrondi: 107254 - 3000 = 104254 MGA\n\n7. Arrondi: 104254 √∑ 500 = 208.508 ‚Üí 209 √ó 500 = 104500 MGA\n\n‚Üí Prix final: 104500 MGA\n```\n\n### Cas 3 : Prix Plancher\n\n**Sc√©nario** : Taxi-moto, 1.5 km, Mardi 8h00, Imm√©diat\n\n```\n1. Prix de base: 1.5 < 3 ‚Üí Prix plancher = 6000 MGA\n2. Embouteillages: 6000 √ó 0.4 = 2400 MGA\n3. R√©servation: 0 MGA\n4. Code promo: 0 MGA\n5. Avant arrondi: 6000 + 2400 = 8400 MGA\n6. Arrondi: 8400 √∑ 500 = 16.8 ‚Üí 17 √ó 500 = 8500 MGA\n\n‚Üí Prix final: 8500 MGA\n```\n\n## ‚ö° Optimisations\n\n### Cache Configuration\n\n```dart\nclass PricingConfigService {\n  static PricingConfigV2? _cachedConfig;\n  static DateTime? _cacheExpiry;\n  \n  static Future<PricingConfigV2> getConfig() async {\n    if (_cachedConfig != null && \n        _cacheExpiry != null && \n        DateTime.now().isBefore(_cacheExpiry!)) {\n      return _cachedConfig!;\n    }\n    \n    _cachedConfig = await _fetchFromFirestore();\n    _cacheExpiry = DateTime.now().add(Duration(minutes: 5));\n    \n    return _cachedConfig!;\n  }\n}\n```\n\n### Pr√©-calculs\n\n```dart\n// Pr√©-calculer les seuils couramment utilis√©s\nclass PricingCalculator {\n  late final double _floorThreshold;\n  late final double _longTripThreshold;\n  late final Map<String, double> _floorPrices;\n  \n  PricingCalculator(PricingConfigV2 config) {\n    _floorThreshold = config.floorPriceThreshold;\n    _longTripThreshold = config.longTripThreshold;\n    _floorPrices = Map.unmodifiable(config.floorPrices);\n  }\n}\n```\n\n## üß™ Tests de Validation\n\n### Tests Unitaires des Algorithmes\n\n```dart\ngroup('Pricing Algorithms', () {\n  late PricingConfigV2 config;\n  \n  setUp(() {\n    config = PricingConfigV2.defaultConfig();\n  });\n  \n  test('Base price calculation - floor price', () {\n    final result = calculateBasePrice('classic', 2.0, config);\n    expect(result, equals(8000.0)); // Prix plancher\n  });\n  \n  test('Base price calculation - normal distance', () {\n    final result = calculateBasePrice('classic', 8.0, config);\n    expect(result, equals(2750.0 * 8.0)); // Prix lin√©aire\n  });\n  \n  test('Base price calculation - long trip', () {\n    final result = calculateBasePrice('classic', 20.0, config);\n    final expected = (2750.0 * 15.0) + ((20.0 - 15.0) * 2750.0 * 1.2);\n    expect(result, equals(expected));\n  });\n  \n  test('Traffic surcharge detection', () {\n    final mondayMorning = DateTime(2025, 1, 6, 8, 0); // Lundi 8h\n    final result = isTrafficHour(mondayMorning, config.trafficPeriods);\n    expect(result, isTrue);\n    \n    final sundayMorning = DateTime(2025, 1, 5, 8, 0); // Dimanche 8h\n    final result2 = isTrafficHour(sundayMorning, config.trafficPeriods);\n    expect(result2, isFalse);\n  });\n  \n  test('Price rounding', () {\n    expect(roundPrice(12250, config), equals(12000)); // Arrondi vers le bas\n    expect(roundPrice(12750, config), equals(13000)); // Arrondi vers le haut\n    expect(roundPrice(12500, config), equals(13000)); // .5 arrondi vers le haut\n  });\n});\n```\n\n### Tests d'Int√©gration\n\n```dart\ntest('Complete pricing calculation', () async {\n  final service = PricingServiceV2();\n  \n  final result = await service.calculatePrice(\n    vehicleCategory: 'classic',\n    distance: 10.0,\n    requestTime: DateTime(2025, 1, 6, 17, 30), // Lundi 17h30\n    isScheduled: true,\n  );\n  \n  // V√©rifications\n  expect(result.basePrice, equals(27500.0)); // 2750 √ó 10\n  expect(result.trafficSurcharge, equals(11000.0)); // 27500 √ó 0.4\n  expect(result.reservationSurcharge, equals(5000.0)); // Classic reservation\n  expect(result.finalPrice, equals(43500.0)); // Arrondi au 500 le plus proche\n});\n```\n\n## üìã Validation des R√©sultats\n\n### R√®gles de Coh√©rence\n\n1. **Prix minimum** : Jamais inf√©rieur au prix plancher\n2. **Prix maximum** : Plafonn√© √† 200000 MGA (s√©curit√©)\n3. **Arrondis** : Toujours multiples de 500 MGA\n4. **Majorations** : Jamais n√©gatives\n5. **Codes promo** : R√©duction ‚â§ prix avant promo\n\n### Assertions de S√©curit√©\n\n```dart\nclass PriceValidator {\n  static bool validateResult(PriceCalculation result) {\n    // Prix final positif\n    if (result.finalPrice <= 0) return false;\n    \n    // Arrondi correct\n    if (result.finalPrice % 500 != 0) return false;\n    \n    // Coh√©rence des composants\n    final expectedTotal = result.basePrice + \n                         result.trafficSurcharge + \n                         result.reservationSurcharge - \n                         result.promoDiscount;\n    \n    // Permettre une diff√©rence due √† l'arrondi\n    final difference = (result.finalPrice - expectedTotal).abs();\n    if (difference > 250) return false; // Max 250 MGA d'√©cart d'arrondi\n    \n    return true;\n  }\n}\n```\n\n---\n\n**Documentation mise √† jour** : 28 juillet 2025  \n**Version** : 1.0